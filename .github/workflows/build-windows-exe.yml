name: Build Windows EXE

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-exe:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 22
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "22"
          cache: maven

      - name: Install WiX Toolset (required for EXE/MSI)
        run: choco install wixtoolset -y

      - name: Build EXE installer (jpackage)
        run: mvn -B -DskipTests clean package jpackage:jpackage

      - name: List built files
        run: dir target\jpackage

      - name: Upload EXE file
        uses: actions/upload-artifact@v4
        with:
          name: HeThongBanVeTau-Windows-Installer
          path: target/jpackage/*.exe
          if-no-files-found: error

      - name: Create Release Info
        run: |
          echo "Build completed at: $(Get-Date)" > target/jpackage/BUILD-INFO.txt
          echo "Java Version: $env:JAVA_VERSION" >> target/jpackage/BUILD-INFO.txt
          echo "Maven Command: mvn clean package jpackage:jpackage" >> target/jpackage/BUILD-INFO.txt
          echo "" >> target/jpackage/BUILD-INFO.txt
          echo "INSTALLATION INSTRUCTIONS:" >> target/jpackage/BUILD-INFO.txt
          echo "1. Download the .exe file" >> target/jpackage/BUILD-INFO.txt
          echo "2. Run the installer" >> target/jpackage/BUILD-INFO.txt
          echo "3. If app doesn't open, check Desktop for log files:" >> target/jpackage/BUILD-INFO.txt
          echo "   - HeThongBanVeTau-launched.txt" >> target/jpackage/BUILD-INFO.txt
          echo "   - HeThongBanVeTau-startup.log" >> target/jpackage/BUILD-INFO.txt
          echo "   - HeThongBanVeTau-ERROR.log (if error occurs)" >> target/jpackage/BUILD-INFO.txt

      - name: Upload Build Info
        uses: actions/upload-artifact@v4
        with:
          name: Build-Information
          path: target/jpackage/BUILD-INFO.txt
